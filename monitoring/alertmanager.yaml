apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-main
  namespace: monitoring
type: Opaque
stringData:
  alertmanager.yaml: |
    global:
      resolve_timeout: 5m

    route:
      receiver: telegram
      group_by: ['alertname', 'namespace']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      routes:
        - receiver: 'null'
          matchers:
            - alertname =~ "InfoInhibitor|Watchdog|KubeSchedulerDown|KubeControllerManagerDown|KubeProxyDown"

    receivers:
      - name: 'null'
      - name: telegram
        telegram_configs:
          - bot_token_file: /etc/alertmanager/secrets/alertmanager-telegram/bot-token
            chat_id: 659782773
            parse_mode: HTML
            message: |
              {{ range .Alerts }}
              {{ if eq .Status "firing" }}üî• <b>FIRING</b>{{ else }}‚úÖ <b>RESOLVED</b>{{ end }}: {{ .Labels.alertname }}
              üì¶ <b>Namespace:</b> {{ .Labels.namespace }}
              üîπ <b>Pod:</b> {{ .Labels.pod }}
              üìù <b>Summary:</b> {{ .Annotations.summary }}
              {{ .Annotations.description }}
              {{ end }}
---
apiVersion: monitoring.coreos.com/v1
kind: Alertmanager
metadata:
  name: main
  namespace: monitoring
spec:
  replicas: 1
  secrets:
    - alertmanager-telegram
  resources:
    requests:
      memory: 64Mi
      cpu: 10m
    limits:
      memory: 128Mi
      cpu: 100m
---
apiVersion: v1
kind: Service
metadata:
  name: alertmanager
  namespace: monitoring
spec:
  selector:
    alertmanager: main
  ports:
    - port: 9093
      targetPort: 9093
